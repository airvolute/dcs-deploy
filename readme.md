`dcs-deploy` packages serves as a tool for flashing Nvidia Jetson family devices supporting airvolute hardware. It is developed for Python 3 only.

# Dependencies
**! DISLAIMER - ALL COMMANDS ARE RUN ON HOST PC !**
### APT

```  
sudo apt install qemu-user-static sshpass abootimg lbzip2  
```    
### Python
```
pip install wget  
```

# Basic usage
- **Put Xavier NX into force recovery mode**

- **cd into dcs-deploy repo**
```
cd /path/to/dcs-deploy
```
- **run dcs_deploy.py**:
```
python3 dcs_deploy.py flash xavier_nx 51 1.2 nvme full
```
or
```
python3 dcs_deploy.py flash xavier_nx 51 1.2 emmc full
```

# Flashing the device again with existing config
If you run the script with `flash` flag, it will re-initialize the Linux for Tegra folder each time. If you just want to re-use the folder and flash the same config to multiple devices, use nvidia flashing script:
 
1. Change directory to to `kernel_flash` dir

```
cd ~/.dcs_deploy/flash/<config_name>/Linux_for_tegra/tools/kernel_flash
```

2. Launch `l4t_initrd_flash.sh` script with appropriate parameters
```
# nvme
sudo ./l4t_initrd_flash.sh --flash-only --external-only --external-device nvme0n1p1 -c flash_l4t_external_custom.xml --showlogs airvolute-dcs1.2+p3668-0001-qspi-emmc nvme0n1p1
# emmc
sudo ./l4t_initrd_flash.sh --flash-only airvolute-dcs1.2+p3668-0001-qspi-emmc mmcblk0p1
```

# Principle
### Basics
The `dcs-deploy.py` script can be used instead of Nvidia SDK manager regarding Airvolute hardware. The main advantages are that this package is lightweight and can be used across different Linux distros or Ubuntu versions (SDK manager is strictly tied between Ubuntu and JetPack version). The script does 3 steps in general:
1. Download Nvidia and custom Airvolute files.
2. Prepare filesystem, which is ready for flashing.
3. Flash the device supporting Airvolute boards.
`dcs-deploy` package leverages many of Nvidia provided scripts.

### Filesystem
Preparing the filesystem is crucial for successful device flashing, despite the carrier board manufacturer. The script prepares/extracts:
1. `Linux For Tegra` folder provided by Nvidia.
2. `Airvolute overlay`, which satisfies carrier board support (HW) for Jetson devices, that are supported at the moment.
3. `Airvolute root filesystem`, which is in fact used as a subfolder inside `Linux For Tegra` folder. At this time, this is just a barebones minimal clean filesystem generated by Nvidia tools. We expect to populate this filesystem with custom Airvolute software in the near future.

As a root of this filesystem, `.dcs_deploy` folder is created inside **host pc HOME** directory. The structure of the folder:
```
.dcs_deploy/
├─ download/
│  ├─ <source webpage hostname>/<path to resource without "download/downloads">
│  ├─ .../
├─ flash/
│  ├─ config_1/
│  ├─ config_2/
│  ├─ .../
├─ downloaded_versions.json

```

- `config` is the name of the downloaded/extracted configuration consisting of device type, flashing memory type, airvolute carrier board version and jetpack version. Example `xavier_nx_emmc_1.2_51`.
- `downloaded_versions.json` consists of configs, that are already downloaded, so if the script is re-ran, those file are not downloaded again and again.
- `download` contains downloaded archives needed for flashing
- `flash` contains extracted folders that are needed for flashing. Those are folders from `download` dir + some nvidia and airvolute scripts applied, so the flashing environment is fully ready.

### Known limitations
- When the script is re-ran, flash config folder is deleted and the files are extracted again.
  - If user customize files in flash config folder, this changes are not saved for next flashing using `dcs-deploy` script.
  - This adds ~3 min time to the whole process.
- The database of configs is held inside this repository, which is not ideal.
- Limited config suppport (only Xavier NX + JP51, emmc or nvme flashing at the moment)
- Download folder is not checked, only `downloaded_versions.json` file is, so if the download folder has been altered script will throw an error.
- Errors that might occur during deployment process are not handled very well at the moment.
- Missing features like kernel building, or `flash-only` that would re-use already prepared flashing config folder. 

### Troubleshooting
#### 1. Verifying 1st boot configuration
To verify, that the full deployment is sucesfull and that the first boot configuration is done you can run these commands on target:

During 1st boot (right after the flashing is completed):
```
$ journalctl -u dcs_first_boot
```
Expected outcome:
`dcs systemd[1]: dcs_first_boot.service: Succeeded.`

After 1st boot.
```
sudo uhubctl
```
Expected outcome:
`List of usb hub port with port 6 disabled.`

**If the output is not as expected, please reboot the device and run after 1st boot command. If the issue with usbhub is persistent please reflash the device.**

#### 2. Device is not booting
- Check if the correct hardware revision of DCS was selected.
- If the device is not booting from NVME, please try to reflash the device using EMMC internal memory and flash again NVME configuration. (only Xavier NX)
